<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Checklist de Limpieza - ASHE S.A.S</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Código de Favicon y PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #0077b6; --accent-color: #00b4d8; --bg-color: #e9ecef;
            --border-color: #dee2e6; --success-color: #28a745; --danger-color: #dc3545;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #343a40; line-height: 1.6; }
        .container { max-width: 960px; margin: auto; background: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); }
        h1 { text-align: center; color: var(--main-color); margin-bottom: 25px; font-weight: 700; }
        label { font-weight: 700; display: block; margin-top: 20px; color: var(--main-color); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--main-color); pointer-events: none; }
        input[type="text"], input[type="datetime-local"] { width: calc(100% - 50px); padding: 12px 12px 12px 45px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #f8f9fa; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: var(--main-color); color: white; }
        input[type="checkbox"] { transform: scale(1.4); accent-color: var(--success-color); }
        .section-title { margin-top: 30px; font-size: 1.3rem; color: var(--main-color); border-left: 6px solid var(--accent-color); padding-left: 15px; font-weight: 700; }
        .btn { display: block; width: 100%; background: linear-gradient(to right, var(--success-color), #218838); color: white; padding: 15px; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; margin-top: 30px; }
        .btn-secondary { background: linear-gradient(to right, var(--main-color), var(--accent-color)); margin-top: 15px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        
        /* ======================================================= */
        /* INICIO: CSS DE MODALES UNIFICADO Y CORREGIDO */
        /* ======================================================= */
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; /* APLICA EL REDONDEO A TODOS */
            box-shadow: 0 5px 25px rgba(0,0,0,0.3); 
            text-align: center; 
            position: relative; 
            animation: modalOpen 0.3s ease-out;
            width: 90%; /* Ancho flexible para responsividad */
            box-sizing: border-box;
            max-height: 85vh; /* Altura máxima para evitar desbordamiento vertical */
            overflow-y: auto; /* Scroll si el contenido es muy alto */
        }
        
        /* Modificadores de ancho que no afectan el diseño base */
        .modal-content-small { max-width: 450px; }
        .modal-content-large { max-width: 700px; }
        /* ======================================================= */
        /* FIN: CSS DE MODALES */
        /* ======================================================= */

        @keyframes modalOpen { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #6c757d; cursor: pointer; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
        .compression-info { background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 0.9rem; }
        .char-count { color: var(--main-color); font-weight: bold; }
        .warning { color: var(--danger-color); }
        .success { color: var(--success-color); }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); font-size: 0.9rem; color: #6c757d; }
        .item-code { color: var(--accent-color); font-weight: bold; font-size: 0.8rem; background: rgba(0, 180, 216, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .preview-content { 
            text-align: left; background: #f8f9fa; padding: 15px; 
            border-radius: 8px; font-family: 'Courier New', monospace; 
            font-size: 0.9rem; white-space: pre-wrap; 
        }
        .export-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .btn-export { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-print { background: var(--main-color); color: white; }
        .btn-download { background: var(--success-color); color: white; }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-truck-moving"></i> Checklist de Limpieza</h1>
    <form id="checklistForm">
        <label for="conductor">Nombre del Conductor:</label>
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="conductor" placeholder="Ej: Elkin Duke" maxlength="20" required>
            <small id="conductorCount" class="char-count">0/20</small>
        </div>
        
        <label for="placa">Placa del Vehículo (máx 8 caracteres):</label>
        <div class="input-group">
            <i class="fas fa-car-side"></i>
            <input type="text" id="placa" placeholder="Ej: WDX171" maxlength="8">
            <small id="placaCount" class="char-count">0/8</small>
        </div>
        
        <label for="datetime">Fecha y Hora de Revisión:</label>
        <div class="input-group"><i class="fas fa-calendar-alt"></i><input type="datetime-local" id="datetime"></div>
        
        <div class="compression-info">
            <strong>Información del QR:</strong><br>
            Tamaño estimado: <span id="qrSize" class="char-count">0</span> bytes<br>
            Estado: <span id="qrStatus" class="success">OK</span>
        </div>
        
        <h2 class="section-title"><i class="fas fa-tint"></i> Zona de Cabina</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Observaciones (máx 15)</th></tr></thead><tbody>
            <tr><td>Tablero limpio <span class="item-code">(TAB)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Volante limpio <span class="item-code">(VOL)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Palanca de cambios <span class="item-code">(PAL)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Asientos limpios <span class="item-code">(ASI)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <h2 class="section-title"><i class="fas fa-glass-whiskey"></i> Vidrios y Espejos</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Observaciones (máx 15)</th></tr></thead><tbody>
            <tr><td>Parabrisas limpio <span class="item-code">(PAR)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Vidrios laterales limpios <span class="item-code">(VID)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Espejos retrovisores <span class="item-code">(ESP)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <h2 class="section-title"><i class="fas fa-trash-alt"></i> Residuos y Desinfección</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Observaciones (máx 15)</th></tr></thead><tbody>
            <tr><td>Sin basura visible <span class="item-code">(BAS)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Superficies desinfectadas <span class="item-code">(DES)</span></td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="15" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <button type="button" class="btn btn-secondary" onclick="mostrarVistaPreviaReporte()"><i class="fas fa-eye"></i> Vista Previa del Reporte</button>
        <button type="button" class="btn" onclick="generarQR()"><i class="fas fa-qrcode"></i> Generar Código QR</button>
    </form>
    
    <div class="footer">
        <p>&copy; 2025 ASHE S.A.S. Todos los derechos reservados.</p>
    </div>
</div>

<div id="qrModal" class="modal">
    <div class="modal-content modal-content-small">
        <span class="modal-close" onclick="cerrarModal('qrModal')"><i class="fas fa-times-circle"></i></span>
        <i class="fas fa-check-circle"></i>
        <h2 style="color:var(--success-color);">¡Código QR Generado!</h2>
        <div id="qrcode"></div>
        <div style="font-size: 0.8rem; margin-top:15px;">Tamaño: <span id="finalQrSize"></span></div>
    </div>
</div>

<div id="alertModal" class="modal">
    <div class="modal-content modal-content-small">
        <span class="modal-close" onclick="cerrarModal('alertModal')"><i class="fas fa-times-circle"></i></span>
        <i class="fas fa-exclamation-triangle"></i>
        <h2 style="color:var(--danger-color);" id="alertTitle">Atención</h2>
        <p id="alertMessage"></p>
    </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-content modal-content-large">
        <span class="modal-close" onclick="cerrarModal('previewModal')"><i class="fas fa-times-circle"></i></span>
        <h2><i class="fas fa-file-alt"></i> Vista Previa del Reporte</h2>
        <div id="previewContent" class="preview-content"></div>
        <div class="export-buttons">
            <button class="btn-export btn-print" onclick="imprimirReporte()">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <button class="btn-export btn-download" onclick="exportarReporte()">
                <i class="fas fa-download"></i> Exportar TXT
            </button>
        </div>
        <button onclick="cerrarModal('previewModal'); generarQR();" style="margin-top: 15px; padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-qrcode"></i> Confirmar y Generar QR
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const itemCodes = ['TAB', 'VOL', 'PAL', 'ASI', 'PAR', 'VID', 'ESP', 'BAS', 'DES'];
    const itemNames = [
        'Tablero limpio', 'Volante limpio', 'Palanca de cambios', 'Asientos limpios', 
        'Parabrisas limpio', 'Vidrios laterales limpios', 'Espejos retrovisores', 
        'Sin basura visible', 'Superficies desinfectadas'
    ];

    document.getElementById('conductor').addEventListener('input', function() {
        document.getElementById('conductorCount').textContent = this.value.length + '/20';
        updateQrSize();
    });
    
    document.getElementById('placa').addEventListener('input', function() {
        document.getElementById('placaCount').textContent = this.value.length + '/8';
        updateQrSize();
    });

    function generateQrContent() {
        const conductor = document.getElementById('conductor').value.trim() || "N/A";
        const placa = document.getElementById('placa').value.trim() || "N/A";
        
        let fechaHora;
        if (document.getElementById('datetime').value) {
            const date = new Date(document.getElementById('datetime').value);
            fechaHora = `${String(date.getDate()).padStart(2,'0')}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
        } else {
            const date = new Date();
            fechaHora = `${String(date.getDate()).padStart(2,'0')}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
        }

        function cleanText(text) { return text.replace(/[^\w\s.-]/g, '').replace(/\s+/g, ' ').trim(); }
        
        const rows = document.querySelectorAll('tbody tr');
        let items = [];
        let observacionesCount = 0;
        
        rows.forEach((row, index) => {
            const checked = row.cells[1].querySelector('input[type="checkbox"]').checked;
            let obs = cleanText(row.cells[2].querySelector('input[type="text"]').value.trim());
            
            if (!checked || obs) {
                let item = itemCodes[index] + (checked ? '1' : '0');
                if (obs) {
                    item += ':' + obs.substring(0, 15);
                    observacionesCount++;
                }
                items.push(item);
            }
        });

        const conductorLimpio = cleanText(conductor).substring(0, 20);
        const placaLimpia = cleanText(placa).substring(0, 8);
        let content = `ASHE-${conductorLimpio}|${placaLimpia}|${fechaHora}`;
        if (items.length > 0) {
            content += '|' + items.join(',');
        } else {
            content += '|OK';
        }
        return { content, observacionesCount };
    }

    function getByteSize(str) { return new Blob([str]).size; }

    function updateQrSize() {
        const { content } = generateQrContent();
        const realSize = getByteSize(content);
        document.getElementById('qrSize').textContent = realSize;
        const statusElement = document.getElementById('qrStatus');
        if (realSize <= 500) {
            statusElement.textContent = 'OK';
            statusElement.className = 'success';
        } else {
            statusElement.textContent = 'ALTO';
            statusElement.className = 'warning';
        }
    }

    function mostrarVistaPreviaReporte() {
        if (!document.getElementById('conductor').value.trim()) {
            mostrarAlerta("Por favor, ingresa el nombre del conductor.");
            return;
        }

        const { content, observacionesCount } = generateQrContent();
        const parts = content.split('|');
        let preview = `╔═══════════════════════════════════════════╗\n`;
        preview += `║           ASHE S.A.S - REPORTE           ║\n`;
        preview += `║        CHECKLIST DE LIMPIEZA             ║\n`;
        preview += `╠═══════════════════════════════════════════╣\n\n`;
        preview += `👤 Conductor: ${parts[0].replace('ASHE-', '')}\n`;
        preview += `🚛 Placa: ${parts[1]}\n`;
        
        if (parts[2] && parts[2].length === 8) {
            const [dd, mm, hh, min] = [parts[2].substring(0,2), parts[2].substring(2,4), parts[2].substring(4,6), parts[2].substring(6,8)];
            preview += `📅 Fecha: ${dd}/${mm} a las ${hh}:${min}\n\n`;
        }
        
        preview += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
        if (parts[3] && parts[3] !== 'OK') {
            preview += `📋 ÍTEMS CON OBSERVACIONES/INCIDENCIAS:\n\n`;
            parts[3].split(',').forEach(item => {
                const code = item.substring(0,3);
                const status = item[3];
                const obs = item.includes(':') ? item.split(':')[1] : '';
                const index = itemCodes.indexOf(code);
                if (index >= 0) {
                    const statusIcon = status === '1' ? '✅' : '❌';
                    preview += `${statusIcon} ${itemNames[index]} (${code})`;
                    if (obs) {
                        preview += `\n   📝 Observación: "${obs}"`;
                    }
                    preview += '\n\n';
                }
            });
        } else {
            preview += `✅ TODOS LOS ÍTEMS VERIFICADOS CORRECTAMENTE\n\n`;
        }
        
        preview += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
        preview += `📊 RESUMEN:\n`;
        preview += `• Observaciones registradas: ${observacionesCount}\n`;
        preview += `• Tamaño del QR: ${getByteSize(content)} bytes\n\n`;
        preview += `© 2025 ASHE S.A.S`;
        
        document.getElementById('previewContent').textContent = preview;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function generarQR() {
        const { content } = generateQrContent();
        const realSize = getByteSize(content);
        
        if (realSize > 1000) {
            mostrarAlerta(`Reporte demasiado extenso (${realSize} bytes).`);
            return;
        }

        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = '';
        document.getElementById('finalQrSize').textContent = `${realSize} bytes`;
        document.getElementById('qrModal').style.display = 'flex';

        setTimeout(() => {
            let qrSize = window.innerWidth < 600 ? 220 : 280;
            try {
                new QRCode(qrDiv, { text: content, width: qrSize, height: qrSize, correctLevel: QRCode.CorrectLevel.L });
            } catch (error) {
                cerrarModal('qrModal');
                mostrarAlerta(`Error al generar QR: ${error.message}`);
            }
        }, 100);
    }
    
    function imprimirReporte() {
        const reportContent = document.getElementById('previewContent').textContent;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>Reporte ASHE</title><style>body{font-family:'Courier New',monospace;}pre{white-space:pre-wrap;}</style></head><body><pre>${reportContent}</pre></body></html>`);
        printWindow.document.close();
        printWindow.print();
    }

    function exportarReporte() {
        const reportContent = document.getElementById('previewContent').textContent;
        const filename = `ASHE_Reporte_${document.getElementById('conductor').value.trim()}_${new Date().toISOString().slice(0,10)}.txt`;
        const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        window.URL.revokeObjectURL(url);
    }
    
    function mostrarAlerta(mensaje) {
        document.getElementById('alertMessage').innerText = mensaje;
        document.getElementById('alertModal').style.display = 'flex';
    }

    function cerrarModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('datetime').value = now.toISOString().slice(0, 16);
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateQrSize();
    });
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').then((reg) => {
        console.log('Service worker listo para funcionar en la web.', reg);
      }).catch(err => {
        console.log('Registro de Service Worker falló (esperado en pruebas locales):', err);
      });
    });
  }
</script>
</body>
</html>