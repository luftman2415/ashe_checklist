<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Checklist de Limpieza - ASHE S.A.S</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-color: #0077b6; --accent-color: #00b4d8; --bg-color: #e9ecef;
            --border-color: #dee2e6; --success-color: #28a745; --danger-color: #dc3545;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #343a40; line-height: 1.6; }
        .container { max-width: 960px; margin: auto; background: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); animation: fadeIn 1s ease-in-out; }
        h1 { text-align: center; color: var(--main-color); margin-bottom: 25px; font-weight: 700; }
        label { font-weight: 700; display: block; margin-top: 20px; color: var(--main-color); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--main-color); pointer-events: none; }
        input[type="text"], input[type="datetime-local"] { width: calc(100% - 50px); padding: 12px 12px 12px 45px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        input[type="text"]:focus, input[type="datetime-local"]:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 5px rgba(0, 180, 216, 0.5); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #f8f9fa; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: var(--main-color); color: white; }
        input[type="checkbox"] { transform: scale(1.4); accent-color: var(--success-color); }
        .section-title { margin-top: 30px; font-size: 1.3rem; color: var(--main-color); border-left: 6px solid var(--accent-color); padding-left: 15px; font-weight: 700; }
        .btn { display: block; width: 100%; background: linear-gradient(to right, var(--success-color), #218838); color: white; padding: 15px; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; margin-top: 30px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); text-align: center; max-width: 450px; position: relative; animation: modalOpen 0.3s ease-out; }
        @keyframes modalOpen { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #6c757d; cursor: pointer; }
        #qrModal .fa-check-circle { font-size: 3rem; color: var(--success-color); margin-bottom: 10px; }
        #alertModal .fa-exclamation-triangle { font-size: 3rem; color: var(--danger-color); margin-bottom: 10px; }
        .modal-content h2 { margin-top: 0; font-weight: 700; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
        .compression-info { background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 0.9rem; }
        .char-count { color: var(--main-color); font-weight: bold; }
        .warning { color: var(--danger-color); }
        .success { color: var(--success-color); }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            th, td { padding: 8px; font-size: 0.9rem; }
        }
    </style>
<!-- Conexión con el Manifiesto de la PWA -->
<link rel="manifest" href="manifest.json">

<!-- Ícono para dispositivos Apple -->
<link rel="apple-touch-icon" href="icon-512x512.png">

<!-- Color de la barra de estado del navegador en móviles -->
<meta name="theme-color" content="#0077b6"/>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-truck-moving"></i> Checklist de Limpieza</h1>
    <form id="checklistForm">
        <label for="conductor">Nombre del Conductor:</label>
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="conductor" placeholder="Ej: Elkin Duke" maxlength="12" required>
            <small id="conductorCount" class="char-count">0/12</small>
        </div>
        
        <label for="placa">Placa del Vehículo (máx 7 caracteres):</label>
        <div class="input-group">
            <i class="fas fa-car-side"></i>
            <input type="text" id="placa" placeholder="Ej: WDX171" maxlength="7">
            <small id="placaCount" class="char-count">0/7</small>
        </div>
        
        <label for="datetime">Fecha y Hora de Revisión:</label>
        <div class="input-group"><i class="fas fa-calendar-alt"></i><input type="datetime-local" id="datetime"></div>
        
        <div class="compression-info">
            <strong>Información del QR:</strong><br>
            Tamaño estimado: <span id="qrSize" class="char-count">0</span> caracteres<br>
            Límite recomendado: <span class="success">400 caracteres</span><br>
            Estado: <span id="qrStatus" class="success">OK</span>
        </div>
        
        <h2 class="section-title"><i class="fas fa-tint"></i> Zona de Cabina</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Obs (máx 8)</th></tr></thead><tbody>
            <tr><td>Tablero limpio</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Volante limpio</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Palanca de cambios</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Asientos limpios</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <h2 class="section-title"><i class="fas fa-glass-whiskey"></i> Vidrios y Espejos</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Obs (máx 8)</th></tr></thead><tbody>
            <tr><td>Parabrisas limpio</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Vidrios laterales limpios</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <h2 class="section-title"><i class="fas fa-trash-alt"></i> Residuos y Desinfección</h2>
        <table><thead><tr><th>Ítem</th><th>OK</th><th>Obs (máx 8)</th></tr></thead><tbody>
            <tr><td>Sin basura visible</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
            <tr><td>Superficies desinfectadas</td><td><input type="checkbox" onchange="updateQrSize()"></td><td><input type="text" name="observaciones" maxlength="8" onkeyup="updateQrSize()"></td></tr>
        </tbody></table>
        
        <button type="button" class="btn" onclick="generarQR()"><i class="fas fa-qrcode"></i> Generar Código QR</button>
    </form>
</div>

<div id="qrModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="cerrarModal('qrModal')"><i class="fas fa-times-circle"></i></span>
        <i class="fas fa-check-circle"></i>
        <h2 style="color:var(--success-color);">¡Código QR Generado!</h2>
        <p>Escanea para ver el reporte completo</p>
        <div id="qrcode"></div>
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.8rem;">
            Tamaño: <span id="finalQrSize"></span> caracteres
        </div>
    </div>
</div>

<div id="alertModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="cerrarModal('alertModal')"><i class="fas fa-times-circle"></i></span>
        <i class="fas fa-exclamation-triangle"></i>
        <h2 style="color:var(--danger-color);" id="alertTitle">Atención</h2>
        <p id="alertMessage"></p>
    </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="cerrarModal('previewModal')"><i class="fas fa-times-circle"></i></span>
        <h2>Vista Previa del Reporte</h2>
        <div id="previewContent" style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap;"></div>
        <button onclick="cerrarModal('previewModal'); generarQR();" style="margin-top: 15px; padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 5px; cursor: pointer;">Generar QR</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    // Contadores de caracteres
    document.getElementById('conductor').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('conductorCount').textContent = count + '/15';
        updateQrSize();
    });
    
    document.getElementById('placa').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('placaCount').textContent = count + '/8';
        updateQrSize();
    });

    // Función para generar el contenido del QR optimizado
    function generateQrContent() {
        const conductor = document.getElementById('conductor').value.trim() || "N/A";
        const placa = document.getElementById('placa').value.trim() || "N/A";
        
        // Fecha manual sin caracteres especiales - formato DDMMHHMM
        let fechaHora;
        if (document.getElementById('datetime').value) {
            const date = new Date(document.getElementById('datetime').value);
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            fechaHora = dd + mm + hh + min;
        } else {
            const date = new Date();
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            fechaHora = dd + mm + hh + min;
        }

        // Limpiar texto de caracteres especiales
        function cleanText(text) {
            return text.replace(/[^\w\s.-]/g, '').replace(/\s+/g, ' ').trim();
        }

        // Códigos ultra comprimidos (1 carácter)
        const itemCodes = ['T', 'V', 'P', 'A', 'B', 'L', 'R', 'D'];
        
        const rows = document.querySelectorAll('tbody tr');
        let items = [];
        
        rows.forEach((row, index) => {
            const checked = row.cells[1].querySelector('input[type="checkbox"]').checked;
            let obs = cleanText(row.cells[2].querySelector('input[type="text"]').value.trim());
            
            // Solo incluir si hay observación O si está desmarcado
            if (!checked || obs) {
                let item = itemCodes[index] + (checked ? '1' : '0');
                if (obs && obs.length > 0) {
                    item += ':' + obs.substring(0, 5); // Máximo 5 chars para obs
                }
                items.push(item);
            }
        });

        // Limpiar nombres de caracteres especiales
        const conductorLimpio = cleanText(conductor).substring(0, 12);
        const placaLimpia = cleanText(placa).substring(0, 7);

        // Estructura ultra comprimida
        let content = `${conductorLimpio}|${placaLimpia}|${fechaHora}`;
        if (items.length > 0) {
            content += '|' + items.join(',');
        }

        return content;
    }

    // Función para calcular el tamaño real en bytes
    function getByteSize(str) {
        return new Blob([str]).size;
    }

    // Función para actualizar el tamaño estimado del QR
    function updateQrSize() {
        const content = generateQrContent();
        const realSize = getByteSize(content);
        
        document.getElementById('qrSize').textContent = realSize;
        
        const statusElement = document.getElementById('qrStatus');
        if (realSize <= 200) {
            statusElement.textContent = 'EXCELENTE';
            statusElement.className = 'success';
        } else if (realSize <= 400) {
            statusElement.textContent = 'BUENO';
            statusElement.className = 'success';
        } else if (realSize <= 600) {
            statusElement.textContent = 'ACEPTABLE';
            statusElement.className = 'char-count';
        } else if (realSize <= 800) {
            statusElement.textContent = 'RIESGO MEDIO';
            statusElement.className = 'warning';
        } else {
            statusElement.textContent = 'RIESGO ALTO';
            statusElement.className = 'warning';
        }
    }

    function mostrarVistaPreviaReporte() {
        const conductor = document.getElementById('conductor').value.trim();
        if (!conductor) {
            mostrarAlerta("Por favor, ingresa el nombre del conductor.");
            return;
        }

        const content = generateQrContent();
        
        // Decodificar para mostrar legible
        const parts = content.split('|');
        let preview = `ASHE S.A.S - Reporte de Limpieza\n\n`;
        preview += `Conductor: ${parts[0]}\n`;
        preview += `Placa: ${parts[1]}\n`;
        
        // Decodificar fecha DDMMHHMM
        if (parts[2] && parts[2].length === 8) {
            const dd = parts[2].substring(0, 2);
            const mm = parts[2].substring(2, 4);
            const hh = parts[2].substring(4, 6);
            const min = parts[2].substring(6, 8);
            preview += `Fecha: ${dd}/${mm} ${hh}:${min}\n\n`;
        } else {
            preview += `Fecha: ${parts[2]}\n\n`;
        }
        
        if (parts[3]) {
            preview += `Ítems con observaciones o no verificados:\n`;
            const items = parts[3].split(',');
            const itemNames = ['Tablero', 'Volante', 'Palanca', 'Asientos', 'Parabrisas', 'Vidrios Lat.', 'Sin Basura', 'Desinfectado'];
            
            items.forEach(item => {
                const code = item[0];
                const status = item[1];
                const obs = item.includes(':') ? item.split(':')[1] : '';
                const index = ['T', 'V', 'P', 'A', 'B', 'L', 'R', 'D'].indexOf(code);
                
                if (index >= 0) {
                    preview += `• ${itemNames[index]}: ${status === '1' ? '✓' : '✗'}`;
                    if (obs) preview += ` (${obs})`;
                    preview += '\n';
                }
            });
        } else {
            preview += `✓ Todos los ítems verificados sin observaciones\n`;
        }
        
        preview += `\n--- Datos codificados ---\n${content}`;
        preview += `\nTamaño real: ${getByteSize(content)} bytes`;
        
        document.getElementById('previewContent').textContent = preview;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function generarQR() {
        const conductor = document.getElementById('conductor').value.trim();
        if (!conductor) {
            mostrarAlerta("Por favor, ingresa el nombre del conductor.");
            return;
        }

        const qrContent = generateQrContent();
        const realSize = getByteSize(qrContent);
        
        // Verificación de tamaño antes de generar
        if (realSize > 700) {
            mostrarAlerta(`El reporte es muy largo (${realSize} bytes). Por favor:\n• Acorta el nombre del conductor\n• Reduce las observaciones\n• Usa menos palabras`);
            return;
        }

        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = '';
        document.getElementById('finalQrSize').textContent = realSize + ' bytes';
        document.getElementById('qrModal').style.display = 'flex';

        setTimeout(() => {
            try {
                new QRCode(qrDiv, {
                    text: qrContent,
                    width: 280,
                    height: 280,
                    correctLevel: QRCode.CorrectLevel.L
                });
            } catch (error) {
                cerrarModal('qrModal');
                mostrarAlerta(`Error al generar QR: ${error.message}\nIntenta reducir más el contenido.`);
            }
        }, 100);
    }
    
    function mostrarAlerta(mensaje) {
        document.getElementById('alertMessage').innerText = mensaje;
        document.getElementById('alertModal').style.display = 'flex';
    }

    function cerrarModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        // Establecer fecha/hora actual por defecto
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('datetime').value = now.toISOString().slice(0, 16);
        
        updateQrSize();
    });
</script>
<script>
  // Registrar el Service Worker para la funcionalidad offline
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').then((reg) => {
        console.log('Service worker registrado.', reg);
      });
    });
  }
</script>
</body>
</html>